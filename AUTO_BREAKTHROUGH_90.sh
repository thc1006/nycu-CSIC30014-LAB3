#!/bin/bash
# ğŸ¯ è‡ªå‹•çªç ´ 90% æµç¨‹
# Gen2 â†’ æ¸¬è©¦ â†’ (å¦‚éœ€) Gen3 â†’ æ¸¬è©¦ â†’ æˆåŠŸï¼

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ¯ è‡ªå‹•çªç ´ 90% æµç¨‹"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================================================
# éšæ®µ 1: ç­‰å¾… Gen2 å®Œæˆ
# ============================================================================
echo "ğŸ“ éšæ®µ 1: æª¢æŸ¥ Gen2 è¨“ç·´ç‹€æ…‹"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

while true; do
    TRAIN_PIDS=$(pgrep -f "train_v2.py.*gen2" | wc -l)
    if [ "$TRAIN_PIDS" -eq 0 ]; then
        echo "âœ… Gen2 è¨“ç·´å·²å®Œæˆï¼"
        break
    else
        echo "â³ Gen2 è¨“ç·´ä¸­... (${TRAIN_PIDS} å€‹é€²ç¨‹é‹è¡Œä¸­)"
        echo "   ä½¿ç”¨ ./monitor_gen2.sh æŸ¥çœ‹é€²åº¦"
        sleep 300  # æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
    fi
done

# ============================================================================
# éšæ®µ 2: ç”Ÿæˆ Gen2 é æ¸¬ä¸¦æäº¤
# ============================================================================
echo ""
echo "ğŸ“ éšæ®µ 2: ç”Ÿæˆ Gen2 é æ¸¬"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

python3 scripts/generate_gen2_predictions.py

if [ ! -f "data/submission_gen2_ensemble.csv" ]; then
    echo "âŒ Gen2 é æ¸¬ç”Ÿæˆå¤±æ•—ï¼"
    exit 1
fi

echo ""
echo "ğŸ“¤ æäº¤ Gen2 é æ¸¬åˆ° Kaggle..."
kaggle competitions submit \
    -c cxr-multi-label-classification \
    -f data/submission_gen2_ensemble.csv \
    -m "Gen2: Pseudo-labeling (532 samples) + 5-Fold Ensemble - Expected 89-90%"

echo ""
echo "â³ ç­‰å¾… Kaggle è©•åˆ†..."
echo "   è«‹æ‰‹å‹•æª¢æŸ¥åˆ†æ•¸ï¼škaggle competitions submissions -c cxr-multi-label-classification"
echo ""
read -p "Gen2 æ¸¬è©¦åˆ†æ•¸æ˜¯å¤šå°‘ï¼Ÿï¼ˆè¼¸å…¥æ•¸å­—ï¼Œå¦‚ 89.5ï¼‰: " GEN2_SCORE

# ============================================================================
# éšæ®µ 3: æ±ºå®šæ˜¯å¦éœ€è¦ Gen3
# ============================================================================
echo ""
echo "ğŸ“ éšæ®µ 3: è©•ä¼°æ˜¯å¦éœ€è¦ Gen3"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# ä½¿ç”¨ bc é€²è¡Œæµ®é»æ•¸æ¯”è¼ƒ
NEED_GEN3=$(echo "$GEN2_SCORE < 90.0" | bc -l)

if [ "$NEED_GEN3" -eq 1 ]; then
    echo "ğŸ“Š Gen2 åˆ†æ•¸: ${GEN2_SCORE}% (< 90%)"
    echo "ğŸš€ å•Ÿå‹• Gen3 è¨“ç·´..."
    echo ""

    # ç”Ÿæˆ Gen3 å½æ¨™ç±¤
    echo "ğŸ“¦ ç”Ÿæˆ Gen3 è‡ªé©æ‡‰å½æ¨™ç±¤..."
    python3 scripts/generate_gen3_adaptive_pseudo_labels.py

    if [ ! -d "data/pseudo_labels_gen3" ]; then
        echo "âŒ Gen3 å½æ¨™ç±¤ç”Ÿæˆå¤±æ•—ï¼"
        exit 1
    fi

    # å•Ÿå‹• Gen3 è¨“ç·´
    echo ""
    echo "ğŸ”¥ å•Ÿå‹• Gen3 è¨“ç·´ï¼ˆé è¨ˆ 7-8 å°æ™‚ï¼‰..."
    bash START_GEN3_TRAINING.sh

    # ========================================================================
    # éšæ®µ 4: Gen3 é æ¸¬ä¸¦æäº¤
    # ========================================================================
    echo ""
    echo "ğŸ“ éšæ®µ 4: ç”Ÿæˆ Gen3 é æ¸¬"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # ç”Ÿæˆ Gen3 é æ¸¬ï¼ˆä½¿ç”¨ç›¸åŒè…³æœ¬ï¼Œåªæ˜¯æ›è·¯å¾‘ï¼‰
    python3 scripts/generate_gen3_predictions.py

    if [ ! -f "data/submission_gen3_ensemble.csv" ]; then
        echo "âŒ Gen3 é æ¸¬ç”Ÿæˆå¤±æ•—ï¼"
        exit 1
    fi

    echo ""
    echo "ğŸ“¤ æäº¤ Gen3 é æ¸¬åˆ° Kaggle..."
    kaggle competitions submit \
        -c cxr-multi-label-classification \
        -f data/submission_gen3_ensemble.csv \
        -m "Gen3: Adaptive Pseudo-labeling (800-900 samples) + 5-Fold - Final Push 90%+"

    echo ""
    echo "âœ… Gen3 æäº¤å®Œæˆï¼"
    echo "   é æœŸåˆ†æ•¸: 89.5-91.0%"

else
    echo "ğŸ‰ğŸ‰ğŸ‰ æ­å–œï¼Gen2 å·²é”æˆ ${GEN2_SCORE}% (>= 90%)ï¼"
    echo "âœ… ç›®æ¨™é”æˆï¼Œç„¡éœ€ Gen3ï¼"
fi

# ============================================================================
# å®Œæˆ
# ============================================================================
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ† è‡ªå‹•çªç ´æµç¨‹å®Œæˆï¼"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š æœ€çµ‚çµæœ:"
if [ "$NEED_GEN3" -eq 1 ]; then
    echo "  Gen2: ${GEN2_SCORE}%"
    echo "  Gen3: å¾…è©•åˆ†"
    echo ""
    echo "ğŸ” æŸ¥çœ‹ Gen3 çµæœ:"
    echo "  kaggle competitions submissions -c cxr-multi-label-classification | head -5"
else
    echo "  Gen2: ${GEN2_SCORE}% âœ… ç›®æ¨™é”æˆï¼"
fi
echo ""
